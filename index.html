
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permainan Labirin Harta Karun</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 95%;
            max-width: 1200px;
            min-height: 600px;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            padding: 20px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 30px;
        }

        .name-input {
            text-align: center;
            margin-bottom: 30px;
        }

        .name-input input {
            padding: 15px 25px;
            font-size: 1.2rem;
            border: 3px solid #ddd;
            border-radius: 50px;
            width: 300px;
            text-align: center;
            margin-right: 15px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
        }

        .menu-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .maze-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 3px solid #333;
            border-radius: 10px;
            overflow: hidden;
            background: #2c3e50;
        }

        .maze {
            position: relative;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(25, 1fr);
            grid-template-rows: repeat(20, 1fr);
        }

        .cell {
            border: 1px solid #34495e;
            position: relative;
        }

        .wall {
            background: #34495e;
        }

        .path {
            background: #ecf0f1;
        }

        .player {
            position: absolute;
            width: 80%;
            height: 80%;
            background: #3498db;
            border-radius: 50%;
            top: 10%;
            left: 10%;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .monster {
            position: absolute;
            width: 80%;
            height: 80%;
            background: #e74c3c;
            border-radius: 50%;
            top: 10%;
            left: 10%;
            z-index: 9;
            animation: pulse 1s infinite;
        }

        .treasure {
            position: absolute;
            width: 80%;
            height: 80%;
            background: #f1c40f;
            top: 10%;
            left: 10%;
            z-index: 8;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .treasure.commented {
            background: #27ae60;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .lives {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .document-viewer {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: auto;
            background: #f9f9f9;
            padding: 20px;
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        .zoom-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .comment-area {
            margin-top: 20px;
        }

        .comment-area textarea {
            width: 100% !important;
            height: 120px !important;
            min-height: 120px !important;
            max-height: 120px !important;
            padding: 15px !important;
            border: 2px solid #ddd !important;
            border-radius: 10px !important;
            resize: none !important;
            font-family: inherit !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            overflow-y: auto !important;
            box-sizing: border-box !important;
            position: static !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: white !important;
            color: black !important;
        }

        .comment-area textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .position-selector {
            display: grid;
            grid-template-columns: repeat(25, 1fr);
            grid-template-rows: repeat(20, 1fr);
            width: 100%;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 20px 0;
        }

        .position-cell {
            border: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .position-cell:hover {
            background: #e3f2fd;
        }

        .position-cell.selected {
            background: #f1c40f;
        }

        .position-cell.wall {
            background: #34495e;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background: #ffeaea;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #27ae60;
            text-align: center;
            padding: 10px;
            background: #eafaf1;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∞ Permainan Labirin Harta Karun üíé</h1>
            <p>Jelajahi labirin dan temukan harta yang tersembunyi!</p>
        </div>

        <div class="content">
            <!-- Name Input Section -->
            <div id="nameSection" class="section active">
                <div class="name-input">
                    <h2>Masukkan Nama Anda</h2>
                    <br>
                    <input type="text" id="playerName" placeholder="Nama Anda..." maxlength="20">
                    <button class="btn btn-primary" onclick="startGame()">Mulai Permainan</button>
                </div>
            </div>

            <!-- Main Game Section -->
            <div id="gameSection" class="section">
                <div class="menu-buttons">
                    <button class="btn btn-success" onclick="showInputMenu()">üì§ Menu Input</button>
                    <button class="btn btn-danger" onclick="showExploreMenu()">üó∫Ô∏è Menu Jelajah</button>
                    <button class="btn btn-primary" onclick="backToName()">üîô Ganti Nama</button>
                </div>

                <!-- Input Menu -->
                <div id="inputMenu" class="section">
                    <h2>üì§ Menu Input Harta</h2>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <h3>üìÑ Klik untuk Unggah Dokumen</h3>
                        <p>Pilih file dokumen untuk dijadikan harta karun</p>
                        <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.png" onchange="handleFileUpload(event)">
                    </div>
                    
                    <div id="positionSection" style="display: none;">
                        <h3>üìç Pilih Lokasi Harta di Labirin</h3>
                        <div class="position-selector" id="positionSelector"></div>
                        <button class="btn btn-success" onclick="saveDocument()">üíæ Simpan Harta</button>
                    </div>
                </div>

                <!-- Explore Menu -->
                <div id="exploreMenu" class="section">
                    <h2>üó∫Ô∏è Menu Jelajah</h2>
                    <div class="game-info">
                        <div class="lives">‚ù§Ô∏è Nyawa: <span id="livesCount">3</span></div>
                        <div>üèÜ Harta Ditemukan: <span id="treasuresFound">0</span>/<span id="totalTreasures">0</span></div>
                        <button class="btn btn-primary" onclick="resetGame()">üîÑ Reset Game</button>
                    </div>
                    <div class="maze-container">
                        <div class="maze" id="maze"></div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <p><strong>Gunakan tombol panah atau WASD untuk bergerak</strong></p>
                        <p>üîµ Anda | üî¥ Monster | üî∫ Harta | üî∫ Harta Berkomentar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìÑ Dokumen Harta</h2>
                <button class="btn btn-danger" onclick="closeModal()" style="padding: 10px 15px;">‚úï</button>
            </div>
            
            <div class="zoom-controls">
                <button class="btn btn-primary" onclick="zoomOut()">üîç‚ûñ</button>
                <button class="btn btn-primary" onclick="resetZoom()">üîç Reset</button>
                <button class="btn btn-primary" onclick="zoomIn()">üîç‚ûï</button>
                <button class="btn btn-success" onclick="openInNewTab()">üîó Buka di Tab Baru</button>
            </div>
            
            <div class="document-viewer" id="documentViewer"></div>
            
            <div class="comment-area">
                <h3>üí¨ Tulis Komentar</h3>
                <textarea id="commentText" placeholder="Tulis komentar Anda tentang dokumen ini..."></textarea>
                <br><br>
                <button class="btn btn-success" onclick="saveComment()">üíæ Simpan Komentar</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let playerName = '';
        let currentFile = null;
        let selectedPosition = null;
        let playerPosition = {x: 1, y: 1};
        let monsters = [];
        let treasures = [];
        let lives = 3;
        let gameRunning = false;
        let currentZoom = 1;
        let currentTreasure = null;
        let commentedTreasures = new Set();

        // API endpoint
        const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwazFQOhWS14mN1pGvNTMv8KGAGCM0u2fAii9MQaMFKtXZnIT3_mhtuxdfL0kg6KHaY/exec';

        // Maze layout (25x20) - 0 = wall, 1 = path
        const mazeLayout = [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0],
            [0,1,0,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0],
            [0,1,0,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,1,0,0,0],
            [0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,0,1,0],
            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0],
            [0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0],
            [0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,1,0,1,0,0,0],
            [0,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,0],
            [0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0],
            [0,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0],
            [0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ];

        async function startGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('Silakan masukkan nama Anda!');
                return;
            }
            
            // Show loading
            const startBtn = document.querySelector('.name-input .btn-primary');
            const originalText = startBtn.textContent;
            startBtn.textContent = '‚è≥ Memulai...';
            startBtn.disabled = true;
            
            try {
                playerName = name;
                
                // Create player sheet if not exists
                await createPlayerSheet();
                
                document.getElementById('nameSection').classList.remove('active');
                document.getElementById('gameSection').classList.add('active');
                loadTreasures();
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Terjadi kesalahan saat memulai permainan');
            } finally {
                // Reset button
                startBtn.textContent = originalText;
                startBtn.disabled = false;
            }
        }

        async function createPlayerSheet() {
            try {
                const data = {
                    action: 'createPlayerSheet',
                    playerName: playerName
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (!result.success) {
                    console.error('Failed to create player sheet:', result.error);
                }
            } catch (error) {
                console.error('Error creating player sheet:', error);
            }
        }

        function backToName() {
            document.getElementById('gameSection').classList.remove('active');
            document.getElementById('nameSection').classList.add('active');
            stopGame();
        }

        function showInputMenu() {
            document.getElementById('inputMenu').classList.add('active');
            document.getElementById('exploreMenu').classList.remove('active');
            createPositionSelector();
            stopGame();
        }

        function showExploreMenu() {
            document.getElementById('exploreMenu').classList.add('active');
            document.getElementById('inputMenu').classList.remove('active');
            initializeMaze();
            loadTreasures();
        }

        function createPositionSelector() {
            const selector = document.getElementById('positionSelector');
            selector.innerHTML = '';
            
            for (let y = 0; y < 20; y++) {
                for (let x = 0; x < 25; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'position-cell';
                    if (mazeLayout[y][x] === 0) {
                        cell.classList.add('wall');
                    } else {
                        cell.onclick = () => selectPosition(x, y, cell);
                    }
                    selector.appendChild(cell);
                }
            }
        }

        function selectPosition(x, y, cell) {
            // Remove previous selection
            document.querySelectorAll('.position-cell.selected').forEach(c => c.classList.remove('selected'));
            
            // Select new position
            cell.classList.add('selected');
            selectedPosition = {x, y};
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFile = file;
            document.getElementById('positionSection').style.display = 'block';
            
            // Show file info
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <h3>üìÑ File Dipilih: ${file.name}</h3>
                <p>Ukuran: ${(file.size / 1024).toFixed(1)} KB</p>
                <p>Sekarang pilih lokasi di labirin untuk meletakkan harta ini</p>
            `;
        }

        async function saveDocument() {
            if (!currentFile || !selectedPosition) {
                alert('Pilih file dan lokasi terlebih dahulu!');
                return;
            }

            // Show loading
            const saveBtn = document.querySelector('#positionSection .btn-success');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '‚è≥ Menyimpan...';
            saveBtn.disabled = true;

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Data = e.target.result.split(',')[1];
                    
                    const data = {
                        action: 'saveDocument',
                        playerName: playerName,
                        fileName: currentFile.name,
                        fileData: base64Data,
                        fileType: currentFile.type,
                        position: selectedPosition
                    };

                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Harta berhasil disimpan!');
                        // Reset form
                        currentFile = null;
                        selectedPosition = null;
                        document.getElementById('fileInput').value = '';
                        document.getElementById('positionSection').style.display = 'none';
                        document.querySelector('.upload-area').innerHTML = `
                            <h3>üìÑ Klik untuk Unggah Dokumen</h3>
                            <p>Pilih file dokumen untuk dijadikan harta karun</p>
                        `;
                        createPositionSelector();
                    } else {
                        alert('Gagal menyimpan harta: ' + result.error);
                    }
                    
                    // Reset button
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                };
                reader.readAsDataURL(currentFile);
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menyimpan harta');
                // Reset button
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        async function loadTreasures() {
            try {
                const data = {
                    action: 'getAllTreasures'  // Changed to get ALL treasures from all players
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    treasures = result.treasures || [];
                    document.getElementById('totalTreasures').textContent = treasures.length;
                    
                    // Load commented treasures for current player
                    await loadCommentedTreasures();
                    
                    if (document.getElementById('exploreMenu').classList.contains('active')) {
                        updateMazeDisplay();
                    }
                }
            } catch (error) {
                console.error('Error loading treasures:', error);
            }
        }

        async function loadCommentedTreasures() {
            try {
                const data = {
                    action: 'getCommentedTreasures',
                    playerName: playerName
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    commentedTreasures = new Set(result.commentedTreasures || []);
                }
            } catch (error) {
                console.error('Error loading commented treasures:', error);
            }
        }

        function initializeMaze() {
            const maze = document.getElementById('maze');
            maze.innerHTML = '';
            
            // Create maze cells
            for (let y = 0; y < 20; y++) {
                for (let x = 0; x < 25; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `cell-${x}-${y}`;
                    
                    if (mazeLayout[y][x] === 0) {
                        cell.classList.add('wall');
                    } else {
                        cell.classList.add('path');
                    }
                    
                    maze.appendChild(cell);
                }
            }

            // Reset player position
            playerPosition = {x: 1, y: 1};
            
            // Initialize monsters
            initializeMonsters();
            
            // Start game
            startGameLoop();
            
            // Update display
            updateMazeDisplay();
            
            // Add keyboard controls
            document.addEventListener('keydown', handleKeyPress);
        }

        function initializeMonsters() {
            monsters = [];
            const monsterPositions = [
                {x: 23, y: 1},
                {x: 1, y: 18},
                {x: 23, y: 18}
            ];
            
            monsterPositions.forEach(pos => {
                monsters.push({
                    x: pos.x,
                    y: pos.y,
                    direction: Math.floor(Math.random() * 4) // 0=up, 1=right, 2=down, 3=left
                });
            });
        }

        function updateMazeDisplay() {
            // Clear all dynamic elements
            document.querySelectorAll('.player, .monster, .treasure').forEach(el => el.remove());
            
            // Add player
            const playerCell = document.getElementById(`cell-${playerPosition.x}-${playerPosition.y}`);
            if (playerCell) {
                const playerEl = document.createElement('div');
                playerEl.className = 'player';
                playerCell.appendChild(playerEl);
            }
            
            // Add monsters
            monsters.forEach(monster => {
                const monsterCell = document.getElementById(`cell-${monster.x}-${monster.y}`);
                if (monsterCell) {
                    const monsterEl = document.createElement('div');
                    monsterEl.className = 'monster';
                    monsterCell.appendChild(monsterEl);
                }
            });
            
            // Add treasures
            treasures.forEach((treasure, index) => {
                const treasureCell = document.getElementById(`cell-${treasure.position.x}-${treasure.position.y}`);
                if (treasureCell) {
                    const treasureEl = document.createElement('div');
                    treasureEl.className = 'treasure';
                    if (commentedTreasures.has(index)) {
                        treasureEl.classList.add('commented');
                    }
                    treasureCell.appendChild(treasureEl);
                }
            });
        }

        function handleKeyPress(event) {
            // Don't handle game keys if modal is open
            if (document.getElementById('documentModal').style.display === 'block') {
                return;
            }
            
            if (!gameRunning) return;
            
            let newX = playerPosition.x;
            let newY = playerPosition.y;
            
            switch(event.key.toLowerCase()) {
                case 'arrowup':
                case 'w':
                    newY--;
                    break;
                case 'arrowdown':
                case 's':
                    newY++;
                    break;
                case 'arrowleft':
                case 'a':
                    newX--;
                    break;
                case 'arrowright':
                case 'd':
                    newX++;
                    break;
                default:
                    return;
            }
            
            event.preventDefault();
            
            // Check bounds and walls
            if (newX >= 0 && newX < 25 && newY >= 0 && newY < 20 && mazeLayout[newY][newX] === 1) {
                playerPosition.x = newX;
                playerPosition.y = newY;
                updateMazeDisplay();
                checkCollisions();
            }
        }

        function moveMonsters() {
            monsters.forEach(monster => {
                const directions = [
                    {x: 0, y: -1}, // up
                    {x: 1, y: 0},  // right
                    {x: 0, y: 1},  // down
                    {x: -1, y: 0}  // left
                ];
                
                // Try to continue in current direction
                let newX = monster.x + directions[monster.direction].x;
                let newY = monster.y + directions[monster.direction].y;
                
                // If can't move in current direction, choose random new direction
                if (newX < 0 || newX >= 25 || newY < 0 || newY >= 20 || mazeLayout[newY][newX] === 0) {
                    // Find valid directions
                    const validDirections = [];
                    directions.forEach((dir, index) => {
                        const testX = monster.x + dir.x;
                        const testY = monster.y + dir.y;
                        if (testX >= 0 && testX < 25 && testY >= 0 && testY < 20 && mazeLayout[testY][testX] === 1) {
                            validDirections.push(index);
                        }
                    });
                    
                    if (validDirections.length > 0) {
                        monster.direction = validDirections[Math.floor(Math.random() * validDirections.length)];
                        newX = monster.x + directions[monster.direction].x;
                        newY = monster.y + directions[monster.direction].y;
                    } else {
                        return; // Can't move
                    }
                }
                
                monster.x = newX;
                monster.y = newY;
            });
        }

        function checkCollisions() {
            // Check monster collisions
            monsters.forEach(monster => {
                if (monster.x === playerPosition.x && monster.y === playerPosition.y) {
                    lives--;
                    document.getElementById('livesCount').textContent = lives;
                    
                    if (lives <= 0) {
                        alert('Game Over! Anda kehabisan nyawa.');
                        resetGame();
                    } else {
                        alert(`Tertangkap monster! Nyawa tersisa: ${lives}`);
                        // Reset player position
                        playerPosition = {x: 1, y: 1};
                        updateMazeDisplay();
                    }
                }
            });

            // Check treasure collisions
            treasures.forEach((treasure, index) => {
                if (treasure.position.x === playerPosition.x &&
                    treasure.position.y === playerPosition.y) {
                    // Only open if not already commented in this session
                    if (!commentedTreasures.has(index)) {
                        openTreasure(treasure, index);
                    }
                }
            });
        }

        function startGameLoop() {
            gameRunning = true;
            
            const gameLoop = setInterval(() => {
                if (!gameRunning) {
                    clearInterval(gameLoop);
                    return;
                }
                
                moveMonsters();
                updateMazeDisplay();
                checkCollisions();
            }, 1000);
        }

        function stopGame() {
            gameRunning = false;
            document.removeEventListener('keydown', handleKeyPress);
        }

        function resetGame() {
            lives = 3;
            document.getElementById('livesCount').textContent = lives;
            document.getElementById('treasuresFound').textContent = 0;
            playerPosition = {x: 1, y: 1};
            stopGame();
            initializeMaze();
        }



        function closeModal() {
            document.getElementById('documentModal').style.display = 'none';
            currentTreasure = null;
            
            // RESUME GAME - Restart game if it was running before
            if (window.gameWasPaused) {
                gameRunning = true;
                startGameLoop();
                window.gameWasPaused = false;
            }
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            document.getElementById('documentViewer').style.transform = `scale(${currentZoom})`;
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.5);
            document.getElementById('documentViewer').style.transform = `scale(${currentZoom})`;
        }

        function resetZoom() {
            currentZoom = 1;
            document.getElementById('documentViewer').style.transform = 'scale(1)';
        }

        async function saveComment() {
            const comment = document.getElementById('commentText').value.trim();
            if (!comment || !currentTreasure) {
                alert('Tulis komentar terlebih dahulu!');
                return;
            }

            try {
                const data = {
                    action: 'saveComment',
                    treasureOwner: currentTreasure.treasure.playerName,
                    commenterName: playerName,
                    comment: comment,
                    treasureIndex: currentTreasure.index
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Komentar berhasil disimpan!');
                    commentedTreasures.add(currentTreasure.index);
                    
                    // Update treasures found count
                    document.getElementById('treasuresFound').textContent = commentedTreasures.size;
                    
                    closeModal();
                    updateMazeDisplay();
                } else {
                    alert('Gagal menyimpan komentar: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menyimpan komentar');
            }
        }

        function openInNewTab() {
            if (!currentTreasure) return;
            
            const treasure = currentTreasure.treasure;
            const dataUrl = `data:${treasure.fileType};base64,${treasure.fileData}`;
            
            // Create a new window/tab with the document
            const newWindow = window.open('', '_blank');
            if (newWindow) {
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${treasure.fileName}</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                font-family: Arial, sans-serif; 
                                background: #f5f5f5;
                            }
                            .header {
                                background: white;
                                padding: 20px;
                                border-radius: 10px;
                                margin-bottom: 20px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            }
                            .content {
                                background: white;
                                padding: 20px;
                                border-radius: 10px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                text-align: center;
                            }
                            img { 
                                max-width: 100%; 
                                height: auto; 
                                border-radius: 8px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                            }
                            iframe { 
                                width: 100%; 
                                height: 80vh; 
                                border: none; 
                                border-radius: 8px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                            }
                            .download-btn {
                                display: inline-block;
                                padding: 12px 24px;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                text-decoration: none;
                                border-radius: 25px;
                                margin-top: 20px;
                                font-weight: bold;
                            }
                            .text-content {
                                background: #f8f9fa;
                                padding: 20px;
                                border-radius: 8px;
                                text-align: left;
                                white-space: pre-wrap;
                                font-family: monospace;
                                max-height: 70vh;
                                overflow-y: auto;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üìÑ ${treasure.fileName}</h1>
                            <p><strong>Tipe:</strong> ${treasure.fileType}</p>
                            <p><strong>Diunggah oleh:</strong> ${treasure.playerName}</p>
                        </div>
                        <div class="content">
                            ${getDocumentContent(treasure, dataUrl)}
                        </div>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            } else {
                // Fallback: direct download
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = treasure.fileName;
                link.click();
            }
        }

        function openPdfInNewTab(pdfDataUrl, fileName) {
            const newWindow = window.open('', '_blank');
            if (newWindow) {
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${fileName}</title>
                        <style>
                            body { margin: 0; padding: 0; background: #333; }
                            iframe { width: 100vw; height: 100vh; border: none; }
                            .fallback { 
                                text-align: center; 
                                padding: 50px; 
                                background: white; 
                                font-family: Arial, sans-serif; 
                            }
                        </style>
                    </head>
                    <body>
                        <iframe src="${pdfDataUrl}" title="${fileName}">
                            <div class="fallback">
                                <h2>PDF tidak dapat ditampilkan</h2>
                                <a href="${pdfDataUrl}" download="${fileName}">Download PDF</a>
                            </div>
                        </iframe>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            }
        }

        function getDocumentContent(treasure, dataUrl) {
            if (treasure.fileType.startsWith('image/')) {
                return `<img src="${dataUrl}" alt="${treasure.fileName}">`;
            } else if (treasure.fileType === 'application/pdf') {
                return `
                    <embed src="${dataUrl}" type="application/pdf" width="100%" height="600px" style="border-radius: 8px;">
                    <div style="text-align: center; margin-top: 20px;">
                        <p><em>Jika PDF tidak tampil, gunakan tombol download</em></p>
                        <a href="${dataUrl}" download="${treasure.fileName}" class="download-btn">üì• Download PDF</a>
                    </div>
                `;
            } else if (treasure.fileType.includes('text/')) {
                try {
                    const decodedText = atob(treasure.fileData);
                    return `<div class="text-content">${decodedText}</div>`;
                } catch (e) {
                    return `
                        <p><em>File tidak dapat ditampilkan dalam browser</em></p>
                        <a href="${dataUrl}" download="${treasure.fileName}" class="download-btn">
                            üì• Download File
                        </a>
                    `;
                }
            } else {
                return `
                    <p><em>File tidak dapat ditampilkan dalam browser</em></p>
                    <a href="${dataUrl}" download="${treasure.fileName}" class="download-btn">
                        üì• Download File
                    </a>
                `;
            }
        }

        // Touch controls for mobile
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!gameRunning) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (deltaX > 30) {
                    // Swipe right
                    handleKeyPress({key: 'arrowright', preventDefault: () => {}});
                } else if (deltaX < -30) {
                    // Swipe left
                    handleKeyPress({key: 'arrowleft', preventDefault: () => {}});
                }
            } else {
                // Vertical swipe
                if (deltaY > 30) {
                    // Swipe down
                    handleKeyPress({key: 'arrowdown', preventDefault: () => {}});
                } else if (deltaY < -30) {
                    // Swipe up
                    handleKeyPress({key: 'arrowup', preventDefault: () => {}});
                }
            }
        });



        // Call protection when modal opens
        function openTreasure(treasure, index) {
            currentTreasure = {treasure, index};
            
            // PAUSE GAME - Stop all game activities
            const wasGameRunning = gameRunning;
            gameRunning = false;
            
            // Store game state for resume
            window.gameWasPaused = wasGameRunning;
            
            // Display document
            const viewer = document.getElementById('documentViewer');
            if (treasure.fileType.startsWith('image/')) {
                viewer.innerHTML = `<img src="data:${treasure.fileType};base64,${treasure.fileData}" style="max-width: 100%; height: auto; border-radius: 8px;">`;
            } else if (treasure.fileType === 'application/pdf') {
                // Try multiple methods for PDF display
                const pdfDataUrl = `data:application/pdf;base64,${treasure.fileData}`;
                
                viewer.innerHTML = `
                    <div style="text-align: center;">
                        <h3>üìÑ ${treasure.fileName}</h3>
                        <p>Diunggah oleh: ${treasure.playerName}</p>
                        
                        <!-- Method 1: Embed tag -->
                        <embed src="${pdfDataUrl}" 
                               type="application/pdf" 
                               width="100%" 
                               height="400px" 
                               style="border-radius: 8px; margin: 10px 0;"
                               id="pdfEmbed">
                        
                        <!-- Method 2: Object tag (fallback) -->
                        <object data="${pdfDataUrl}" 
                                type="application/pdf" 
                                width="100%" 
                                height="400px" 
                                style="border-radius: 8px; margin: 10px 0; display: none;"
                                id="pdfObject">
                            <p>PDF tidak dapat ditampilkan</p>
                        </object>
                        
                        <!-- Method 3: Download link -->
                        <div style="margin-top: 20px;">
                            <a href="${pdfDataUrl}" 
                               download="${treasure.fileName}" 
                               class="btn btn-primary" 
                               style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">
                               üì• Download PDF
                            </a>
                            <button onclick="openPdfInNewTab('${pdfDataUrl}', '${treasure.fileName}')" 
                                    class="btn btn-success" 
                                    style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #56ab2f, #a8e6cf); color: white; border: none; border-radius: 25px; font-weight: bold; margin-left: 10px; cursor: pointer;">
                               üîó Buka di Tab Baru
                            </button>
                        </div>
                        
                        <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                            <em>Jika PDF tidak tampil, coba download atau buka di tab baru</em>
                        </p>
                    </div>
                `;
                
                // Check if embed works, if not show object
                setTimeout(() => {
                    const embed = document.getElementById('pdfEmbed');
                    const object = document.getElementById('pdfObject');
                    if (embed && embed.offsetHeight === 0) {
                        embed.style.display = 'none';
                        object.style.display = 'block';
                    }
                }, 1000);
            } else if (treasure.fileType.includes('text/')) {
                // For text files, decode base64 and display
                try {
                    const decodedText = atob(treasure.fileData);
                    viewer.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: left; white-space: pre-wrap; font-family: monospace;">
                            ${decodedText}
                        </div>
                    `;
                } catch (e) {
                    viewer.innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <h3>üìÑ ${treasure.fileName}</h3>
                            <p>Tipe: ${treasure.fileType}</p>
                            <p>Diunggah oleh: ${treasure.playerName}</p>
                            <p><em>File tidak dapat ditampilkan dalam browser</em></p>
                        </div>
                    `;
                }
            } else {
                viewer.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h3>üìÑ ${treasure.fileName}</h3>
                        <p>Tipe: ${treasure.fileType}</p>
                        <p>Diunggah oleh: ${treasure.playerName}</p>
                        <p><em>File tidak dapat ditampilkan dalam browser</em></p>
                        <a href="data:${treasure.fileType};base64,${treasure.fileData}" 
                           download="${treasure.fileName}" 
                           class="btn btn-primary" 
                           style="display: inline-block; margin-top: 15px;">
                           üì• Download File
                        </a>
                    </div>
                `;
            }
            
            // Reset zoom
            currentZoom = 1;
            viewer.style.transform = 'scale(1)';
            
            // Clear comment
            document.getElementById('commentText').value = '';
            
            // Show modal
            document.getElementById('documentModal').style.display = 'block';
        }

        // Pinch zoom for document viewer
        let initialDistance = 0;
        let initialZoom = 1;

        document.getElementById('documentViewer').addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                initialDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                initialZoom = currentZoom;
            }
        });

        document.getElementById('documentViewer').addEventListener('touchmove', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const currentDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                
                const scale = currentDistance / initialDistance;
                currentZoom = Math.max(0.5, Math.min(3, initialZoom * scale));
                this.style.transform = `scale(${currentZoom})`;
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9804f80356edf92e',t:'MTc1ODA3Mzk5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
